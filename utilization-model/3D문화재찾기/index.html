<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>문화재 찾기 게임</title>
  <link rel="icon" type="image/png" href="./img/favicon.png" />
  <script type="text/javascript" src="https://map.vworld.kr/js/webglMapInit.js.do?version=3.0&apiKey=CEB52025-E065-364C-9DBA-44880E3B02B8"></script>
  <script type="text/javascript" src="https://map.vworld.kr/js/dtkmap/tool3d/libapis/routeSim/routeSim_analysis_api.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

    body {
      margin: 0;
      font-family: 'NanumGothic', sans-serif;
    }
    #vmap {
      width: 100%;
      height: 100vh;
    }

    #startImage {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 720px;
      transform: translate(-50%, -50%);
      z-index: 1000;
    }

    #regionSelector.image-buttons {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: row;
      gap: 40px;
      z-index: 1001;
      display: none;
      animation: floatIn 1s ease-out;
    }

    #regionSelector.image-buttons img {
      width: 160px;
      height: auto;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    
    #regionSelector.image-buttons img:hover {
      transform: scale(1.3);
    }

    @keyframes floatIn {
      from { opacity: 0; transform: translate(-50%, -60%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }
    
    #routeButtons {
      position: absolute;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1100;
      padding: 12px;
      border-radius: 12px;
      display: flex;
      gap: 10px;
    }

    #routeButtons.image-buttons {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1100;
      padding: 20px;
      border-radius: 20px;
      display: none;
      flex-direction: row;
      gap: 50px;
      animation: floatIn 1s ease-out;
      /* 배경이미지 */
      background-repeat: no-repeat;
      background-size: contain;
      background-position: center;
      padding: 55px 36px;
      width: 750px;
      height: 250px;
    }

    #routeButtons.image-buttons img {
      width: auto;
      height: auto;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    #routeButtons.image-buttons img:hover {
      transform: scale(1.2);
    }

    #startBtn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      width: 300px;      
      height: auto;
      cursor: pointer;
      display: none;
      animation: floatIn 1s ease-out;
    }

    /* 전체 상단 위치 컨테이너 */
    .arrival-popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 9999;
      pointer-events: none;
    }

    /* 등수 라벨 */
    .rank-label {
      font-family: 'Jua', sans-serif; /* 귀여운 웹폰트 */
      font-size: 42px;
      color: #ffffff;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); /* 검은 그림자 */
      margin-bottom: 15px;
    }

    /* 붕붕 애니메이션 */
    @keyframes floatUpDown {
      0% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
      100% { transform: translateY(0); }
    }

    .floating-marker {
      animation: floatUpDown 1.5s ease-in-out infinite;
    }

    #resetImageBtn {
      position: absolute;
      top: 30px;
      right: 30px;
      z-index: 2000;
      width: 180px;
      height: auto;
      cursor: pointer;
      display: none;
      transition: transform 0.3s ease;
    }
    #resetImageBtn:hover {
      transform: scale(1.1);
    }

    #miniMapImage {
      position: absolute;
      bottom: 40px;
      left: 20px;
      width: 500px;
      height: auto;
      z-index: 1500;
      border: 2px solid white;
      border-radius: 12px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>
  <div id="vmap"></div>
  <img id="startImage" src="./img/main_nobutton.png" />
  <div id="regionSelector" class="image-buttons">
    <img src="./img/1_seoul.png" onclick="moveToHeritage('seoul')" />
    <img src="./img/2_suwon.png" onclick="moveToHeritage('suwon')" />
    <img src="./img/3_daejeon.png" onclick="moveToHeritage('daejeon')" />
  </div>
  <img id="startBtn" src="./img/start.png" onclick="startRoute()" />
  <div class="geojson">
    <textarea class="form-control" id="routeGeoJSONTextarea" rows="4" hidden></textarea>
  </div>
  <div id="routeButtons" style="display: none;"></div>
  <img id="resetImageBtn" src="./img/restart.png" onclick="resetToStart()" />
  <img id="miniMapImage" src="" style="display:none;" />
  <script>
    // 문화재별 설정: 좌표(lon,lat), 높이(alt), 회전반경(range)
    const configs = {
      seoul:   { lon:126.9769,       lat:37.5796,       alt:300, range:400 },
      suwon:   { lon:127.016941,    lat:37.277818, alt:300, range:300 },
      daejeon: { lon:127.388008,       lat:36.376622,       alt:300, range:500 }
    };
    // 맵 & 뷰어 변수
    let map, viewer, rotateId;
    // 초기 카메라 위치
    const initPos = { lon:126.9401465303777, lat:37.519874413465715, alt:800, heading:0, pitch:-70 };

    map = new vw.Map();
    map.setOption({
    mapId: 'vmap',
    initPosition: new vw.CameraPosition(
        new vw.CoordZ(initPos.lon, initPos.lat, initPos.alt),
        new vw.Direction(initPos.heading, initPos.pitch, 0)
    ),
    logo: true,
    navigation: false
    });
    map.setMapId('vmap');
    map.start();

    viewer = ws3d.viewer;

    let miro_name = '';
    let miro_geom = [];
    let miro_road = [];

    let routeSimObject; // 모의주행 객체
    let crashPointEntities = []; //충돌지점
    let selectedRoute = null;
    let geojsonData = null;
    let routeMonitorTimer = null;

    const routeBranchTables = {
      seoul: {
        'seoul_1': [
          { name: '1_seoul_success_1st', label: '1번 경로', rank: 1 },
          { name: '1_seoul_fail_2nd_1', label: '2번 경로', rank: 2 },
          { name: '1_seoul_fail_2nd_2', label: '3번 경로', rank: 2 }
        ],
        'seoul_2': [
          { name: '2_seoul_1', label: '1번 경로', rank: 3 },
          { name: '2_seoul_2', label: '2번 경로', rank: 3 }
        ],
        'seoul_3': [
          { name: '3_seoul_1', label: '1번 경로', rank: 3 },
          { name: '3_seoul_2', label: '2번 경로', rank: 3 }
        ]
      },
      suwon: {
        'suwon_1': [
          { name: '1_suwon_1', label: '1번 경로', rank: 3 },
          { name: '1_suwon_2', label: '2번 경로', rank: 3 }
        ],
        'suwon_2': [
          { name: '2_suwon_1', label: '1번 경로', rank: 3 },
          { name: '2_suwon_2', label: '2번 경로', rank: 3 }
        ],
        'suwon_3': [
          { name: '3_suwon_fail_2nd_1', label: '1번 경로', rank: 2 },
          { name: '3_suwon_fail_2nd_2', label: '2번 경로', rank: 2 },
          { name: '3_suwon_success_1st', label: '3번 경로', rank: 1 }
        ]
      },
      daejeon : {
        'daejeon_1': [
          { name: '1_daejeon_1', label: '1번 경로', rank: 3 },
          { name: '1_daejeon_2', label: '2번 경로', rank: 3 }
        ],
        'daejeon_2': [
          { name: '2_daejeon_fail_2nd_1', label: '1번 경로', rank: 2 },
          { name: '2_daejeon_success_1st', label: '2번 경로', rank: 1 },
          { name: '2_daejeon_fail_2nd_2', label: '3번 경로', rank: 2 }
        ],
        'daejeon_3': [
          { name: '3_daejeon_1', label: '1번 경로', rank: 3 },
          { name: '3_daejeon_2', label: '2번 경로', rank: 3 }
        ]
      }
    };

    // VWorld 초기화 콜백
    vw.ws3dInitCallBack = function() {
      map.getElementById('poi_road').hide();
      map.getElementById('poi_base').hide();
      map.getElementById('poi_bound').hide();

      document.getElementById('regionSelector').style.display = 'flex';
    };

    // 문화재 선택 후 해당 위치로 이동하고 회전 시작
    function moveToHeritage(key) {
      window.currentRegion = key;
      window.currentKey = key;
      const cfg = configs[key];
      document.getElementById('startImage').style.display = 'none';
      document.getElementById('regionSelector').style.display = 'none';
      const dest = Cesium.Cartesian3.fromDegrees(cfg.lon, cfg.lat, cfg.alt);
      viewer.camera.flyTo({
        destination: dest,
        orientation: { heading: Cesium.Math.toRadians(0), pitch: Cesium.Math.toRadians(-45), roll:0 },
        duration:2,
        complete: () => {
          startRotation(cfg);
          document.getElementById('startBtn').style.display = 'block'; 
        }
      });
    }

    // 출발지 시뮬레이션 시작 함수
    function startRoute() {
      document.getElementById('startBtn').style.display = 'none';

      // 1. 회전 중지
      if (rotateId) {
        clearInterval(rotateId);
        rotateId = null;
        viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);
      }
      
      const region = window.currentRegion || 'seoul';

      const geojsonUrl = `./geojson/${region}.geojson`;

      // 2. GeoJSON 불러오기
      $.ajax({
        url: geojsonUrl,
        // dataType: 'json', 운영 서버(tomcat) 적용 시
        success: function(data) {
          const allFeatures = data.features;

          const baseNames = [`${region}_1`, `${region}_2`, `${region}_3`];
          const filtered = allFeatures.filter(f => baseNames.includes(f.properties.Name));

          // ✅ 동적으로 버튼 생성
          const container = document.getElementById('routeButtons');
          container.innerHTML = '';
          container.className = 'image-buttons';
         
          baseNames.forEach((name, idx) => {
            const img = document.createElement('img');
            img.src = `./img/route_${idx + 1}.png`; // 예: route_1.png, route_2.png, ...
            img.alt = `${idx + 1}번 경로`;
            img.onclick = () => {
              const miniMap = document.getElementById('miniMapImage');
              if (miniMap) miniMap.style.display = 'none';

              container.style.display = 'none';
              container.classList.remove('show');
              selectRoute(name);
            };
            container.appendChild(img);
          });

          if (baseNames.length === 3) {
            container.style.backgroundImage = "url('./img/route_3button.png')";
          } else if (baseNames.length === 2) {
            container.style.backgroundImage = "url('./img/route_2button.png')";
          }

          // 1. 저장해두기 (전역 변수 활용)
          window.routeFeatures = allFeatures; // feature array 저장
          window.geojsonData    = data;

          if (!allFeatures || allFeatures.length === 0) {
            alert("GeoJSON에 feature가 없습니다.");
            return;
          }

          // 3. 첫 번째 feature의 시작 위치로 카메라 이동
          const startCoordsTable = {
            seoul:   [126.9890087, 37.561121, 100],     // 경복궁 근처
            suwon:   [127.0252691, 37.2899247,    100],     // 팔달문 근처
            daejeon: [127.3535672, 36.3507401,    100]      // 대전 엑스포 근처
          };

          const firstCoords = startCoordsTable[region]

          const [lon, lat, alt = 100] = firstCoords;
          const cameraHeight = 1000; 
          const startPosition = Cesium.Cartesian3.fromDegrees(lon, lat, cameraHeight);

          viewer.camera.flyTo({
            destination: startPosition,
            orientation: {
              heading: Cesium.Math.toRadians(0),
              pitch: Cesium.Math.toRadians(-90),
              roll: 0
            },
            duration: 2
          });

          // 5. 필터링된 결과로 FeatureCollection 생성
          const partialGeoJSON = {
            type: "FeatureCollection",
            name: `${region}_filtered`,
            crs: data.crs || {
              type: "name",
              properties: { name: "EPSG:4326" }
            },
            features: filtered
          };

          viewer.dataSources.removeAll();
          // 7. 화면에 로드
          Cesium.GeoJsonDataSource.load(partialGeoJSON, {
            clampToGround: true,
            stroke: Cesium.Color.TRANSPARENT,
            fill: Cesium.Color.TRANSPARENT,
            strokeWidth: 0
          }).then(function (dataSource) {
            viewer.dataSources.removeAll();
            viewer.dataSources.add(dataSource);

            setTimeout(() => {
              const miniMap = document.getElementById('miniMapImage');
              miniMap.src = `./img/minimap_${region}_0.png`;
              miniMap.style.display = 'block';
              
              const container = document.getElementById('routeButtons');
              container.style.display = 'flex';
              container.classList.add('show');
            }, 3000); // 3000ms = 3초
          }).catch(function (error) {
            console.error('GeoJSON 로드 오류:', error);
          });
        },
        error: function () {
          alert("GeoJSON 파일을 불러오는 데 실패했습니다.");
        }
      });

      //document.getElementById('routeButtons').style.display = 'flex';
    }

    function getLastCoordinate(feature) {
      const geom = feature.geometry;

      if (geom.type === 'LineString') {
        const coords = geom.coordinates;
        return coords[coords.length - 1].slice(0, 2); // [lon, lat]
      }

      if (geom.type === 'MultiLineString') {
        const multi = geom.coordinates;
        const lastLine = multi[multi.length - 1];
        if (!lastLine || lastLine.length === 0) return null;
        return lastLine[lastLine.length - 1].slice(0, 2); // [lon, lat]
      }

      return null;
    }

    function selectRoute(routeName) {
      
      window.currentRouteName = routeName;

      if (!window.routeFeatures || routeFeatures.length === 0) {
        alert('경로 정보가 로드되지 않았습니다.');
        return;
      }

      const feature = routeFeatures.find(f => f.properties.Name === routeName);
      if (!feature) {
        alert(`경로 ${routeName} 를 찾을 수 없습니다.`);
        return;
      }

      // ▶️ 마지막 지점 기억
      const lastCoord = getLastCoordinate(feature);
      if (!lastCoord) {
        console.warn('❌ 마지막 좌표 추출 실패:', routeName);
        return;
      }

      const raw = feature.geometry.coordinates;
      const multi = Array.isArray(raw[0][0]) ? raw : [raw];

      const geojson = {
        type: "FeatureCollection",
        name: "miro_geojson",
        crs: { type: "name", properties: { name: "EPSG:4326" } },
        features: [{
          type: "Feature",
          properties: { name: routeName },
          geometry: { type: "MultiLineString", coordinates: multi }
        }]
      };

      Cesium.GeoJsonDataSource.load(geojson, {
        crsNames: 'EPSG:4326',
        stroke: Cesium.Color.TRANSPARENT,
        fill: Cesium.Color.TRANSPARENT,
        strokeWidth: 0,
        clampToGround: true
      }).then(function (dataSource) {
        viewer.dataSources.removeAll();
        viewer.dataSources.add(dataSource);
        viewer.zoomTo(dataSource);
      });

      // 시뮬레이터 준비
      if (!routeSimObject) {
        routeSimObject = new RouteSimulation('routeSimObject1', 'routeSimObject1', 'DRONE');
      } else {
        routeSimObject.type = 'DRONE';
      }

      routeSimObject.createRouteByGeoJSON(geojson);
      routeSimObject.playRouteSimulation(700, 0.5, '#FFFFFF', 75);
      routeSimObject.trackedModel('fpView', true);

      // ▶️ 모델 위치 추적해서 도착 감지
      if (routeMonitorTimer) clearInterval(routeMonitorTimer);
      routeMonitorTimer = setInterval(() => {
        if (!routeSimObject.modelEntity) return;

        const position = routeSimObject.modelEntity.position?.getValue(viewer.clock.currentTime);
        if (!position) return;

        const cartographic = Cesium.Cartographic.fromCartesian(position);
        const lon = Cesium.Math.toDegrees(cartographic.longitude);
        const lat = Cesium.Math.toDegrees(cartographic.latitude);

        const dx = lon - lastCoord[0];
        const dy = lat - lastCoord[1];
        const distSq = dx * dx + dy * dy;

        if (distSq < 0.0000005) {
          clearInterval(routeMonitorTimer);
          console.log('✅ 도착 확인', lon, lat);
          routeSimObject.pauseRouteSimulation();
          showBranchOptions();
        }
        
      }, 500);

      console.log('📌 선택한 경로:', routeName);
      console.log('📌 마지막 좌표:', lastCoord);
      document.getElementById('routeButtons').style.display = 'none';
      document.getElementById('miniMapImage').style.display = 'none';
    }

    // 회전 애니메이션 실행
    function startRotation({lon, lat, range}) {
      if (rotateId) clearInterval(rotateId);
      const center = Cesium.Cartesian3.fromDegrees(lon, lat, 0);
      const pitch = Cesium.Math.toRadians(-45);
      let hd = 0;
      rotateId = setInterval(() => {
        const heading = Cesium.Math.toRadians(hd);
        viewer.camera.lookAt(center, new Cesium.HeadingPitchRange(heading, pitch, range));
        hd = (hd + 0.3) % 360;
      }, 50);
    }

    function showBranchOptions() {
      const routeName = window.currentRouteName;
      const region = window.currentRegion;
      const branches = routeBranchTables[region]?.[routeName];

      const container = document.getElementById('routeButtons');
      container.innerHTML = ''; // 기존 버튼 제거
      container.className = 'image-buttons';

      const baseIndex = ['_1', '_2', '_3'].findIndex(suffix => routeName.endsWith(suffix));
      if (baseIndex !== -1) {
        const miniMap = document.getElementById('miniMapImage');
        miniMap.src = `./img/minimap_${region}_${baseIndex + 1}.png`;
        miniMap.style.display = 'block';
      }
      
      if (!branches || branches.length === 0) {
        container.style.display = 'none';
        container.classList.remove('show');

        document.getElementById('miniMapImage').style.display = 'none';

        // ✅ 마커 이미지 선택 로직
        let imgSrc = '';
        let rankMessage = '';

        if (routeName.includes('success')) {
          const regionNames = {
            seoul: '경복궁',
            suwon: '팔달문',
            daejeon: '엑스포 한빛탑'
          };

          const placeName = regionNames[region] || '문화재';
          const successMessage = `1등 ! ${placeName}에 도착했습니다`;

          showArrivalEffect(successMessage, null); // 이미지 없이
        } else {
          const rand = Math.floor(Math.random() * 3); // 0, 1, 2
          const options = [
            { img: './img/re_zuvi.png', msg: '2등! 쥬비 발견' },
            { img: './img/re_ddid.png', msg: '3등! 띠드 발견' },
            { img: './img/re_v.png', msg: '1등! 뷔 발견' }
          ];
          const selected = options[rand];
          imgSrc = selected.img;
          rankMessage = selected.msg;
        }

        showArrivalEffect(rankMessage, imgSrc);

        document.getElementById('resetImageBtn').style.display = 'block';

        return;    
      }

      branches.forEach((branch, idx) => {
        const img = document.createElement('img');
        img.src = `./img/route_${idx + 1}.png`;  // 👉 index 기반 이미지 사용
        img.alt = branch.label;
        img.onclick = () => {
          container.style.display = 'none';
          container.classList.remove('show');
          selectRoute(branch.name);
        };
        container.appendChild(img);
      });

      if (branches.length === 3) {
        container.style.backgroundImage = "url('./img/route_3button.png')";
        container.style.padding = '55px 36px';
      } else if (branches.length === 2) {
        container.style.backgroundImage = "url('./img/route_2button.png')";
        container.style.padding = '50px 145px';
        //55px 158px
      }

      container.style.display = 'flex';
      container.classList.add('image-buttons');
    }

    function showArrivalEffect(rank, imgSrc) {
      const existing = document.querySelector('.arrival-popup');
      if (existing) return; // 이미 떠 있으면 중복 방지

      const container = document.createElement('div');
      container.className = 'arrival-popup';

      const label = document.createElement('div');
      label.className = 'rank-label';
      label.innerText = rank;

      container.appendChild(label);

      // 이미지가 있을 때만 생성
      if (imgSrc) {
        const img = document.createElement('img');
        img.src = imgSrc;
        img.className = 'floating-marker';
        container.appendChild(img);
      }

      document.body.appendChild(container);
    }

    function resetToStart() {
      location.reload();
    }

    function showMiniMap(imgName) {
      const miniMap = document.getElementById('miniMapImage');
      miniMap.src = `./img/${imgName}`;
      miniMap.style.display = 'block';
    }

  </script>
</body>
</html>
