<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>경찰청 안전Dream API 연계 서비스(2D)</title>
  <!-- OpenLayers (v6.x UMD) -->
   <link rel="stylesheet" href="https://openlayers.org/en/latest/css/ol.css" type="text/css">
  <!--<script src="https://cdn.jsdelivr.net/npm/ol@6.15.1/dist/ol.js"></script>-->
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
  <style>
    :root { 
      --sidebar-w: 560px; 
      --side-current: var(--sidebar-w); 
      --brand:#007bff; 
      --border:#e5e7eb; 
      --bg:#f8fafc; 
    }

    * {
       box-sizing: border-box; 
      }

    html, body { 
      height: 100%; 
    }

    body { 
      margin:0; 
      padding:0; 
      font-size:13px; 
      line-height:1.5; 
      color:#1f2937; 
      font-family:'NanumGothic';
      overflow: hidden; 
    }
    body.side-collapsed { 
      --side-current: 0px; 
    }

    #app { 
      display:flex; 
      height: 100vh; 
      width:100vw; 
      background:#fff; 
    }

    #mapWrap { 
      flex: 1 1 auto; 
      min-width: 0; 
      position:relative; 
    }

    #vmap { 
      width:100%; height:100%; 
    }

    #sideWrap { 
      width: var(--side-current); 
      transition: width .25s ease; 
      overflow:hidden; 
      display:flex; 
      flex-direction:column; 
      height:100vh; 
    }
    #sideHeader { 
      padding:12px; 
      border-bottom:1px solid var(--border); 
      background:#fff; 
      position:sticky; 
      top:0; 
      z-index:3; 
    }
    #sideHeader h2 { 
      margin:0 0 10px; 
      font-size:18px; 
      font-weight:800; 
      color:#111827; 
    }

    #tabs { 
      display:grid; 
      grid-template-columns: 
      repeat(3, 1fr); 
      width:100%; 
      gap:0; 
    }
    .tab { 
      width:100%; 
      padding:10px 12px; 
      border:1px solid var(--border); 
      background:#fff; 
      cursor:pointer; 
      font-weight:700; 
      color:#374151; 
    }
    .tab.active { 
      background:var(--brand); 
      color:#fff; 
      border-color:var(--brand); 
    }

    #result { 
      overflow:auto; 
      padding:12px; 
      background:#fff; 
      flex: 1 1 auto; 
      min-height:0; 
    }

    .filter-card { 
      background:var(--bg); 
      border:1px solid var(--border); 
      border-radius:12px; 
      padding:12px; 
      margin-bottom:10px; 
    }
    .filter-row { 
      display:flex; 
      flex-wrap:wrap; 
      align-items:center; 
      gap:12px; 
    }
    .filter-row strong { 
      min-width:56px; 
    }
    .filter-actions { 
      margin-left:auto; 
    }
    .btn { 
      display:inline-flex; 
      align-items:center; 
      gap:6px; 
      padding:8px 12px; 
      border:1px solid var(--border); 
      background:#fff; 
      border-radius:10px; 
      cursor:pointer; 
      font-weight:700; 
    }
    .btn.primary { 
      background:var(--brand); 
      color:#fff; 
      border-color:var(--brand); 
    }

    table { 
      width: 100%; 
      border-collapse: 
      collapse; 
      background:#fff; 
      border-radius:12px; 
      overflow:hidden; 
      border:1px solid var(--border); 
    }
    th, td { 
      border-top:1px solid var(--border); 
      padding:8px; 
      text-align:center; 
    }
    thead th { 
      background:#f3f4f6; 
      font-weight:800; 
    }
    tbody tr:hover { 
      background:#f9fafb; 
    }
    .row { 
      cursor:pointer; 
    }
    .muted { 
      color:#6b7280; 
    }

    #pager { 
      display:flex; 
      flex-wrap:wrap; 
      gap:6px; 
      margin:12px 0 4px; 
      justify-content:center; 
    }
    .page-btn { 
      min-width:34px; 
      height:34px; 
      padding:0 10px; 
      display:inline-flex; 
      align-items:center; 
      justify-content:center; 
      border:1px solid var(--border); 
      background:#fff; 
      border-radius:8px; 
      cursor:pointer; 
    }
    .page-btn.active { 
      background:var(--brand); 
      color:#fff; 
      border-color:var(--brand); 
      font-weight:800; 
    }

    #loading { 
      position:absolute; 
      inset:0; 
      display:none; 
      align-items:center; 
      justify-content:center; 
      background:rgba(255,255,255,0.6); 
      z-index:4; 
    }
    .spinner { 
      width:48px; 
      height:48px; 
      border:5px solid #ddd; 
      border-top-color:var(--brand); 
      border-radius:50%; 
      animation:spin 0.9s linear infinite; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #toggleSide{ 
      position:absolute; 
      top:50%; 
      right:0; 
      transform: translateY(-50%); 
      z-index:5; 
      width:32px; 
      height:80px; 
      background:#fff; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      cursor:pointer; 
      font-weight:800; 
    }
    #toggleSide:active{ transform: translateY(-50%) scale(0.96); }

    /* OpenLayers 팝업 */
    .ol-popup { 
      position: absolute; 
      background: #fff; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 10px; 
      min-width: 450px;
      box-shadow: 0 10px 30px rgba(0,0,0,.12); 
      transform: translate(-50%, -100%);
    }

    .ol-popup .popup-closer{
      position:absolute; 
      top:6px; 
      right:6px; 
      width:28px; 
      height:28px; 
      display:flex; 
      align-items:center; 
      justify-content:center;
      background:transparent; 
      border:0; 
      font-size:18px; 
      line-height:1; 
      color:#6b7280; 
      cursor:pointer; 
    }
    .ol-popup .popup-closer:hover{ color:#111827; }

  </style>
</head>
<body>
  <div id="app">
    <div id="mapWrap">
      <div id="vmap"></div>
      <div id="loading"><div class="spinner" aria-label="loading"></div></div>
      <button id="toggleSide" aria-expanded="true" title="사이드 닫기">◀</button>
    </div>
    <aside id="sideWrap">
      <div id="sideHeader">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <h2>실종/경보/안전지도 조회(2D)</h2>
          <span class="muted" style="font-size:12px;">[출처 : 경찰청]</span>
        </div>
        <div id="tabs">
          <button class="tab active" data-tab="FIND">실종검색</button>
          <button class="tab" data-tab="AMBER">실종경보</button>
          <button class="tab" data-tab="SAFEMAP">안전지도</button>
        </div>
      </div>

      <div id="result">
        <div id="filters" class="filter-card">
          <div class="filter-row" id="safemapFilter">
            <strong>분류</strong>
            <label><input type="radio" name="clRadio" value="09" checked> 아동안전지킴이어린이집</label>
            <label><input type="radio" name="clRadio" value="23"> 노인보호시설</label>
            <div class="filter-actions">
              <button id="safemapSearchBtn" class="btn primary">화면 범위로 검색</button>
            </div>
          </div>
        </div>

        <div id="legend" class="muted" style="margin:4px 2px 8px; font-size:12px;">
          대상구분: 010-정상아동(18세미만) · 060-지적장애인 · 070-치매질환자
        </div>
        <div id="countBar" class="muted" style="margin:6px 2px 8px;">총 0건</div>
        <div id="tableWrap"></div>
        <div id="pager"></div>
      </div>
    </aside>
  </div>

<script>

const POLICE_ESNTL_ID = '10000831'; // 경찰청 고유ID
const POLICE_AUTH_KEY  = '2a3a75f6fbb149a0'; // 경찰청 인증키
const VWORLD_REST_KEY  = 'EEEEEEEE-EEEE-EEEE-EEEE-EEEEEEEEEEEE'; // 데이터 키
const VWORLD_TILE_KEY  = 'CEB52025-E065-364C-9DBA-44880E3B02B8'; // WMTS API
const VWORLD_PROXY     = 'https://map.vworld.kr/proxy.do?url=';  // 브이월드 프록시

// 디바운스 (맵 이동 끝난 후 일정 시간 지난 뒤 호출)
const debounce = (fn, ms=400) => {
  let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); };
};

// 현재 뷰 Extent(3857) → 경위도(BBOX 4326)로 변환
function getViewBbox4326() {
  const ext = map.getView().calculateExtent(map.getSize()); // [minX, minY, maxX, maxY] in EPSG:3857
  const min = ol.proj.toLonLat([ext[0], ext[1]]); // [lon, lat]
  const max = ol.proj.toLonLat([ext[2], ext[3]]);
  return { minX: min[0], minY: min[1], maxX: max[0], maxY: max[1] };
}

let map, view, vectorSource, vectorLayer, popupOverlay, popupEl, popupContentEl;
let dataset = [];
const PAGE_SIZE = 10;
let currentPage = 1;
const coordCache = new Map();
let activeTab = 'FIND'; // 'FIND' | 'AMBER' | 'SAFEMAP'

function showLoading(on=true){ 
  document.getElementById('loading').style.display = on? 'flex':'none'; 
}

function updateLegend(){ 
  const el = document.getElementById('legend'); 
  if (el) el.style.display = (activeTab === 'SAFEMAP') ? 'none' : 'block'; 
}

function updateSidebarToggleUI(){ 
  const btn = document.getElementById('toggleSide'); 
  const collapsed = document.body.classList.contains('side-collapsed'); 
  
  if (!btn) return; 
  btn.setAttribute('aria-expanded', String(!collapsed)); 
  btn.title = collapsed ? '사이드 열기' : '사이드 닫기'; btn.textContent = collapsed ? '▶' : '◀'; 
}

// 지도 초기화
function initMap() {
  const base = new ol.layer.Tile({
    source: new ol.source.XYZ({
      url: `https://api.vworld.kr/req/wmts/1.0.0/${VWORLD_TILE_KEY}/Base/{z}/{y}/{x}.png`
    })
  });

  vectorSource = new ol.source.Vector();
  vectorLayer = new ol.layer.Vector({ source: vectorSource });

  view = new ol.View({ center: ol.proj.fromLonLat([126.927758, 37.525019]), zoom: 7 });
  map = new ol.Map({ target: 'vmap', layers: [base, vectorLayer], view });

  // 팝업
  popupEl = document.createElement('div');
  popupEl.className = 'ol-popup';
  popupEl.innerHTML = `
    <button type="button" class="popup-closer" aria-label="닫기">×</button>
    <div class="popup-content"></div>
  `;
  const popupCloserEl = popupEl.querySelector('.popup-closer');
  popupContentEl = popupEl.querySelector('.popup-content');

  const POPUP_Y_OFFSET = -52;
  popupOverlay = new ol.Overlay({
    element: popupEl,
    positioning: 'center',    
    offset: [0, POPUP_Y_OFFSET], 
    stopEvent: true,
    autoPan: true,
    autoPanMargin: 24,
    autoPanAnimation: { duration: 200 }
  });
  map.addOverlay(popupOverlay);

  // 닫기 버튼 핸들러
  popupCloserEl.addEventListener('click', () => {
    popupOverlay.setPosition(undefined);
  });

  map.on('singleclick', (evt) => {
    let hit = false;
    map.forEachFeatureAtPixel(evt.pixel, (feature) => {
      hit = true;
      const html = feature.get('popupHtml') || '';
      popupContentEl.innerHTML = html;
      popupOverlay.setPosition(feature.getGeometry().getCoordinates());
      return true;
    });
    if (!hit) popupOverlay.setPosition(undefined);
  });
}

// 옵션: 로컬 정적 서버에서는 서버 프록시 시도 끄기
const SERVER_PROXY_ENABLED = false;

// SAFEMAP: 서버 프록시가 있으면 사용, 없으면 VWorld 프록시로 폴백
async function fetchSafeMapInView() {
  const { minX, minY, maxX, maxY } = getViewBbox4326();
  const clArr = getSafeMapSelectedCodes();

  // 서버 프록시 비활성화면 바로 VWorld 프록시 사용
  if (typeof SERVER_PROXY_ENABLED !== 'undefined' && !SERVER_PROXY_ENABLED) {
    return fetchSafeMapViaVworld({ minX, minY, maxX, maxY }, clArr);
  }

  // 1) 서버 프록시 먼저 시도
  try {
    const qs = new URLSearchParams({
      esntlId: POLICE_ESNTL_ID,
      authKey: POLICE_AUTH_KEY,
      pageIndex: '1',
      pageUnit: '100',
      minX: String(minX),
      minY: String(minY),
      maxX: String(maxX),
      maxY: String(maxY),
    });
    clArr.forEach(v => qs.append('clArray', v));

    const r = await fetch('/api/safe-map?' + qs.toString(), {
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    });
    if (!r.ok) throw new Error('server proxy not available: ' + r.status);

    const text = await r.text();
    let data;
    try { data = JSON.parse(text); }
    catch { data = JSON.parse(text.replace(/<br\s*\/?>(?=)/gi,' ')); }

    const list = Array.isArray(data.list) ? data.list
               : Array.isArray(data.result?.list) ? data.result.list
               : Array.isArray(data.resultList) ? data.resultList
               : [];

    dataset = list;
    renderTable(1);
    return;
  } catch {
    // 2) 폴백: VWorld 공개 프록시 경유 (개발용)
    return fetchSafeMapViaVworld({ minX, minY, maxX, maxY }, clArr);
  }
}

// VWorld 공개 프록시를 통한 SAFEMAP 호출 
async function fetchSafeMapViaVworld(bbox, clArr) {
  const endpoint = 'https://www.safe182.go.kr/api/lcm/safeMap.do';
  const PAGE_UNIT = 200;
  const MAX_PAGES = 50;
  const acc = [];

  for (let pageIndex = 1; pageIndex <= MAX_PAGES; pageIndex++) {
    const ordered = [];
    ordered.push(['pageIndex','1']);
    ordered.push(['pageUnit','100']);
    ordered.push(['minX', String(bbox.minX)]);
    ordered.push(['minY', String(bbox.minY)]);
    ordered.push(['maxX', String(bbox.maxX)]);
    ordered.push(['maxY', String(bbox.maxY)]);
    (clArr && clArr.length ? clArr : ['09']).forEach(v => ordered.push(['clArray', v]));

    ordered.push(['authKey', POLICE_AUTH_KEY]);
    ordered.push(['esntlId', POLICE_ESNTL_ID]);

    const qs = ordered.map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
    const url = VWORLD_PROXY + encodeURIComponent(`${endpoint}?${qs}`);

    const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
    const text = await r.text();
    if (!r.ok) throw new Error('safemap via vworld failed ' + r.status + ': ' + text.slice(0,300));

    let data;
    try { data = JSON.parse(text); }
    catch { data = JSON.parse(text.replace(/<br\s*\/?>/gi, ' ')); }

    const list = Array.isArray(data.list) ? data.list
                : Array.isArray(data.result?.list) ? data.result.list
                : Array.isArray(data.resultList) ? data.resultList
                : [];

    acc.push(...list);
    if (list.length < PAGE_UNIT) break;
  }

  dataset = acc;
  renderTable(1);
}


function resizeMapSafely(){ 
  try { 
    if (map && typeof map.updateSize === 'function') map.updateSize(); 
  } catch(e){
  } 
}

function move(lon, lat){
  const center = ol.proj.fromLonLat([Number(lon), Number(lat)]);
  view.animate({ center, duration: 300 });
  if (view.getZoom() < 12) view.animate({ zoom: 12, duration: 250 });
}

function createMarker(rec, idxGlobal){
  const lon = Number(rec.x), lat = Number(rec.y);
  if (!isFinite(lon) || !isFinite(lat)) return;
  const name = (activeTab==='SAFEMAP') ? (rec.bsshNm || rec.clNm || '') : (rec.occrAdres || '');
  const iconUrl = (activeTab==='SAFEMAP') ? 'https://www.vworld.kr/img/marker/static/img01.png' : 'https://www.vworld.kr/img/marker/static/img09.png';

  const feature = new ol.Feature({
    geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat])),
    popupHtml: buildDetailByTab(rec),
    name
  });
  feature.setStyle(new ol.style.Style({
    image: new ol.style.Icon({ src: iconUrl, anchor: [0.5, 1], scale: 1 }),
    text: new ol.style.Text({
      text: String(name || ''),
      font: '13px "NanumGothic"',
      textAlign: 'center',
      textBaseline: 'top',
      offsetY: 10, // ← 양수: 마커 아래쪽으로 라벨 이동
      fill: new ol.style.Fill({ color: '#111' }),
      stroke: new ol.style.Stroke({ color: '#fff', width: 3 })
    })
  }));
  vectorSource.addFeature(feature);
}

function clearMarkers(){ 
  try { 
    vectorSource && vectorSource.clear(); 
    if (popupOverlay) popupOverlay.setPosition(undefined); 
  } catch(e){ 
    console.warn('마커 제거 중 오류', e);
  } 
}

// 데이터 호출 
async function fetchFindPage(pageNum) {
  const endpoint = 'https://www.safe182.go.kr/api/lcm/findChildList.do';
  const writngTrgetDscds = ['010','060','070'];
  const p = new URLSearchParams({ 
    rowSize: '100', page: String(pageNum), 
    esntlId: POLICE_ESNTL_ID, 
    authKey: POLICE_AUTH_KEY 
  });

  writngTrgetDscds.forEach(v=>p.append('writngTrgetDscds', v));
  const url = VWORLD_PROXY + encodeURIComponent(`${endpoint}?${p.toString()}`);
  const r = await fetch(url, { headers: { 'Accept':'application/json' }});
  const text = await r.text(); 
  if (!r.ok) throw new Error('find upstream '+r.status+': '+text.slice(0,300));
  let json; 
  try { json = JSON.parse(text); } 
  catch { json = JSON.parse(text.replace(/<br\s*\/?>(?=)/gi,' ')); }
  return Array.isArray(json.list) ? json.list : [];
}
async function fetchAllFindList(maxPages=50){ 
  const all=[]; 
  for(let p=1;p<=maxPages;p++){ 
    const list=await fetchFindPage(p); 
    all.push(...list); 
    if(list.length<100) break; 
  } 
  return all; 
}

async function fetchAmberPage(pageNum){
  const endpoint = 'https://www.safe182.go.kr/api/lcm/amberList.do';
  const d = new Date();
  const ymd = String(d.getFullYear())+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0');
  const p = new URLSearchParams({ rowSize: '100', page: String(pageNum), occrde: ymd, esntlId: POLICE_ESNTL_ID, authKey: POLICE_AUTH_KEY });
  const url = VWORLD_PROXY + encodeURIComponent(`${endpoint}?${p.toString()}`);
  const r = await fetch(url, { headers: { 'Accept':'application/json' }});
  const text = await r.text(); if (!r.ok) throw new Error('find upstream '+r.status+': '+text.slice(0,300));
  let json; 
  try { json = JSON.parse(text); } 
  catch { json = JSON.parse(text.replace(/<br\s*\/?>(?=)/gi,' ')); }
  return Array.isArray(json.list) ? json.list : [];

  /*
  const endpoint = 'https://www.safe182.go.kr/api/lcm/amberList.do';
  const d = new Date(); const ymd = String(d.getFullYear())+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0');
  const body = new URLSearchParams();
  body.set('esntlId', POLICE_ESNTL_ID); body.set('authKey', POLICE_AUTH_KEY);
  body.set('rowSize','100'); 
  body.set('page', String(pageNum));
  body.set('occrde', ymd); // 필수
  const r = await fetch(VWORLD_PROXY + encodeURIComponent(endpoint), { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded', 'Accept':'application/json' }, body });
  const text = await r.text(); if (!r.ok) throw new Error('amber upstream '+r.status+': '+text.slice(0,300));
  let json; try { json = JSON.parse(text); } catch { json = JSON.parse(text.replace(/<br\s*\/?>(?=)/gi,' ')); }
  return Array.isArray(json.list) ? json.list : [];
  */
}
async function fetchAllAmber(maxPages=50){ 
  const all=[]; 
  for(let p=1 ;p<=maxPages; p++){ 
    const list = await fetchAmberPage(p); 
    all.push(...list); 
    if(list.length<100) break; 
  } return all; 
}

// 목록/마커 공통 팝업 오픈 헬퍼
function openPopupAt(lon, lat, html){
  if (!isFinite(lon) || !isFinite(lat)) return;
  if (!popupOverlay || !popupContentEl) return;
  try {
    popupContentEl.innerHTML = html || '';
    const coord = ol.proj.fromLonLat([Number(lon), Number(lat)]);
    popupOverlay.setPosition(coord);
  } catch(e) {}
}

// VWorld 지오코딩 — JSONP (브라우저 CORS 회피)
function geocode(address, addressType='road'){
  return new Promise((resolve)=>{
    if (!address) return resolve(null);
    if (coordCache.has(address)) return resolve(coordCache.get(address));

    $.ajax({
      url: 'https://api.vworld.kr/req/address', 
      dataType:'jsonp', 
      timeout: 8000,
      data: { 
        service : 'address', 
        request : 'getCoord', 
        version : '2.0', 
        crs : 'epsg:4326', 
        address, 
        type : addressType, 
        refine : true, 
        simple : false, 
        format : 'json', 
        key : VWORLD_REST_KEY 
      }, success: function(g){ 
        
        const ok = g?.response?.status === 'OK'; 
        const result = ok ? { status:'OK', x:g.response.result.point.x, y:g.response.result.point.y } : null; 
        coordCache.set(address, result); 
        resolve(result);
      }, error: function(){ 
        coordCache.set(address, null); 
        resolve(null); 
      }
    });
  });
}

// 표/상세/마커
function clLabel(code){ 
  const dict={ '09':'09-아동안전지킴이어린이집','23':'23-노인보호시설' }; return dict[String(code)] || ''; 
}

function buildRowFIND_AMBER(item, idxGlobal){ 
  const hasImg = (item.tknphotolength!=='0'); 
  const imgCell = hasImg?`
    <a target="_blank" href="https://www.safe182.go.kr/home/lcm/lcmMssGet.do?gnbMenuCd=014000000000&lnbMenuCd=014001000000&rptDscd=2&msspsnIdntfccd=${item.msspsnIdntfccd||''}">
      <img style="width:48px;height:64px;object-fit:cover" src="https://www.safe182.go.kr/api/lcm/imgView.do?msspsnIdntfccd=${item.msspsnIdntfccd||''}" />
    </a>`:'&nbsp;'; 
    
    return `<tr class="row" id="row_${idxGlobal}" data-gidx="${idxGlobal}" data-x="" data-y="">
      <td>${item.occrde||''}</td>
      <td>${item.nm||''}</td>
      <td>${item.sexdstnDscd||''}</td>
      <td>${item.occrAdres||''}</td>
      <td>${imgCell}</td>
      </tr>`; 
}
function buildRowSAFEMAP(item, idxGlobal){ 
  return `<tr class="row" id="row_${idxGlobal}" data-gidx="${idxGlobal}" data-x="${item.lcinfoLo||''}" data-y="${item.lcinfoLa||''}"><td>
    ${clLabel(item.cl)||item.clNm||''}</td>
    <td>${item.bsshNm||''}</td>
    <td>${item.adres||''}</td>
    <td>${item.telno||''}</td>
    </tr>`; 
}
function buildRowByTab(item, idxGlobal){ 
  return (activeTab==='SAFEMAP') ? buildRowSAFEMAP(item, idxGlobal) : buildRowFIND_AMBER(item, idxGlobal); 
}

function buildDetailTableFIND_AMBER(item){ 
  const hasImg=(item.tknphotolength!=='0'); 
  const imgCell=hasImg?`
    <a target="_blank" href="https://www.safe182.go.kr/home/lcm/lcmMssGet.do?gnbMenuCd=014000000000&lnbMenuCd=014001000000&rptDscd=2&msspsnIdntfccd=${item.msspsnIdntfccd||''}">
      <img style="width:96px;height:128px;object-fit:cover" src="https://www.safe182.go.kr/api/lcm/imgView.do?msspsnIdntfccd=${item.msspsnIdntfccd||''}"/>
    </a>`:'&nbsp;'; 
    
    return `<div style="font-weight:700;margin:2px 0 10px;">실종자 상세 정보</div>
    <table style="width:100%;border-collapse:collapse;">
      <tr>
        <td>발생일시</td>
        <td>${item.occrde||''}</td>
        <td>착의사항</td>
        <td>${item.alldressingDscd||''}</td>
      </tr>
      <tr>
        <td>현재나이</td>
        <td>${item.ageNow||''}</td>
        <td>당시나이</td>
        <td>${item.age||''}</td>
      </tr>
      <tr>
        <td>대상구분</td>
        <td>${item.writngTrgetDscd||''}</td>
        <td>성별구분</td>
        <td>${item.sexdstnDscd||''}</td>
      </tr>
      <tr>
        <td>발생장소</td>
        <td>${item.occrAdres||''}</td>
        <td>성명</td><td>${item.nm||''}</td>
      </tr>
      <tr>
        <td>키</td>
        <td>${item.height||''}</td>
        <td>몸무게</td>
        <td>${item.bdwgh||''}</td>
      </tr>
      <tr>
        <td>체격</td>
        <td>${item.frmDscd||''}</td>
        <td>얼굴형</td>
        <td>${item.faceshpeDscd||''}</td>
      </tr>
      <tr>
        <td>두발형태</td>
        <td>${item.hairshpeDscd||''}</td>
        <td>두발색상</td>
        <td>${item.haircolrDscd||''}</td>
      </tr>
      <tr>
        <td>사진</td>
        <td colspan="3">${imgCell}</td>
      </tr>
    </table>`; 
}
function buildDetailTableSAFEMAP(item){ 
  return `<div style="font-weight:700;margin:2px 0 10px;">안전시설 상세 정보</div>
  <table style="width:100%;border-collapse:collapse;">
    <tr>
      <td>분류</td>
      <td>${item.clNm||''}</td>
      <td>명칭</td>
      <td>${item.bsshNm||''}</td>
    </tr>
    <tr>
      <td>주소</td>
      <td colspan="3">${item.adres||''} ${item.etcAdres||''}</td>
    </tr>
    <tr>
      <td>전화</td>
      <td>${item.telno||''}</td>
      <td>일련번호</td>
      <td>${item.lcSn||''}</td>
    </tr>
  </table>`;
}
function buildDetailByTab(item){ 
  return (activeTab === 'SAFEMAP') ? buildDetailTableSAFEMAP(item) : buildDetailTableFIND_AMBER(item); 
}

function updateCounters(total, page){ 
  const totalPage = Math.max(1, Math.ceil(total/PAGE_SIZE));
  document.getElementById('countBar').textContent=`총 ${total}건 / 페이지 ${page} / ${totalPage}`;
}

function renderPager(total, page){ 
  const totalPage = Math.max(1, Math.ceil(total/PAGE_SIZE)); 
  const pager = document.getElementById('pager'); 
  const blockSize = 10; 
  const blockStart = Math.floor((page-1)/blockSize)*blockSize + 1; 
  const blockEnd = Math.min(blockStart+blockSize-1, totalPage); 
  const btn = (p,l,cls) => `<button class="page-btn ${cls||''}" data-page="${p}">${l}</button>`; 
  const parts = []; 
  if ( page > 1)  parts.push(btn(1,'<<')); 
  if ( blockStart > 1 ) parts.push(btn(Math.max(1, blockStart - blockSize), '<')); 
  for ( let i=blockStart; i<=blockEnd; i++ ) parts.push(btn(i, String(i), (i === page?'active':''))); 
  if( blockEnd < totalPage ) parts.push(btn(Math.min(totalPage, blockStart + blockSize), '>')); 
  if( page < totalPage) parts.push(btn(totalPage,'>>')); 
  pager.innerHTML = parts.join(''); 
}
function renderTable(page=1){ 
  currentPage = page; 
  const total = dataset.length; 
  updateCounters(total,page); 
  const start = (page-1)*PAGE_SIZE; 
  const pageItems = dataset.slice(start, start+PAGE_SIZE); 
  const thead = (activeTab === 'SAFEMAP')?'<tr><th>분류</th><th>명칭</th><th>주소</th><th>전화</th></tr>':'<tr><th>발생일시</th><th>성명</th><th>성별</th><th>발생장소</th><th>사진</th></tr>'; 
  const rowsHtml = pageItems.map((it,i)=>buildRowByTab(it, start+i)).join(''); 
  document.getElementById('tableWrap').innerHTML = `<table><thead>${thead}</thead><tbody>${rowsHtml}</tbody></table>`; renderPager(total, page); 
  renderMarkersForPage(pageItems, start); 
}

async function renderMarkersForPage(pageItems, startIndex){ 
  showLoading(true); 
  clearMarkers(); 
  let moved = false; 

  for(let i=0; i<pageItems.length; i++){ 
    const item = pageItems[i]; 
    const idxGlobal = startIndex + i; 
    const rowEl = document.getElementById('row_'+idxGlobal); 

    try { 
      if (activeTab === 'SAFEMAP'){ 
        const x = parseFloat(item.lcinfoLo), y = parseFloat(item.lcinfoLa); 
        if (isFinite(x) && isFinite(y)) { 
          item.x = x; 
          item.y = y;

          if (rowEl){ 
            rowEl.dataset.x = x; 
            rowEl.dataset.y = y; 
          } 
          
          createMarker(item, idxGlobal); 
          if(!moved){ move(x,y); moved = true; } 
        
        } else if (rowEl){ 
          rowEl.dataset.x = ''; 
          rowEl.dataset.y = ''; 
        }

      } else { 
        const info = await geocode(item.occrAdres || ''); 
        if (info && info.status==='OK'){ 
          const x = info.x, y = info.y; 
          item.x = x; 
          item.y = y; 
          
          if (rowEl){ 
            rowEl.dataset.x = x; 
            rowEl.dataset.y = y; 
          } 
          createMarker(item, idxGlobal); 
          
          if(!moved){ 
            move(x,y); 
            moved = true; 
          } 

        } else if (rowEl){ 
          rowEl.dataset.x = ''; 
          rowEl.dataset.y = ''; 
        } 
      } 
    } catch(e){ 
      if (rowEl){ 
        rowEl.dataset.x = ''; 
        rowEl.dataset.y = ''; 
      } 
    } 

  } showLoading(false); 
}

function getSafeMapSelectedCodes(){ 
  const v=document.querySelector('input[name="clRadio"]:checked')?.value; 
  return v ? [v] : ['09']; 
}
function updateFiltersVisibility(){ 
  const filters=document.getElementById('filters'); 
  const safemapRow=document.getElementById('safemapFilter'); 
  if(!filters) return; 
  
  if (activeTab==='SAFEMAP'){ 
    filters.style.display='block'; 
    if (safemapRow) safemapRow.style.display='flex'; 
  } else { 
    filters.style.display='none'; 
    if (safemapRow) safemapRow.style.display='none'; 
  } 
}

document.getElementById('tableWrap').addEventListener('click', async (e)=>{ 
  const tr=e.target.closest('tr.row'); 
  if(!tr) return; 
  const gidx=Number(tr.getAttribute('data-gidx')); 

  const rec=dataset[gidx]; 
  let x=parseFloat(tr.dataset.x), y=parseFloat(tr.dataset.y); 

  if (!(isFinite(x)&&isFinite(y)) && rec && activeTab!=='SAFEMAP'){ 
    const info=await geocode(rec.occrAdres||''); 
    if (info && info.status==='OK'){ 
      x = info.x; 
      y = info.y; 
      tr.dataset.x = x; 
      tr.dataset.y = y; 
      rec.x = x; 
      rec.y = y; 
      
      createMarker(rec, gidx); 
    }
  } 

  if (isFinite(x) && isFinite(y)) {
    move(x, y);
    const html = buildDetailByTab(rec);
    openPopupAt(x, y, html);
  }
});

document.getElementById('pager').addEventListener('click', (e)=>{ 
  const btn=e.target.closest('.page-btn'); 
  if(!btn) return; 
  const p=Number(btn.dataset.page); 
  if (p && p!==currentPage) renderTable(p); 
});

document.getElementById('tabs').addEventListener('click', async (e)=>{ 
  const btn=e.target.closest('.tab'); 
  if(!btn) return; 

  document.querySelectorAll('#tabs .tab').forEach(b=>b.classList.remove('active')); 
  btn.classList.add('active'); 
  activeTab=btn.dataset.tab;

  updateFiltersVisibility(); 
  updateLegend(); 
  await loadAndPlot(); 
});

document.getElementById('safemapSearchBtn').addEventListener('click', async ()=>{ 
  //const debouncedSearch = debounce(fetchSafeMapInView, 400);
  //map.on('moveend', debouncedSearch);

  if (activeTab!=='SAFEMAP'){ 
    document.querySelectorAll('#tabs .tab').forEach(b=>b.classList.remove('active')); 
    document.querySelector('#tabs .tab[data-tab="SAFEMAP"]').classList.add('active'); 
    activeTab='SAFEMAP'; 
    updateFiltersVisibility(); 
    updateLegend(); 
  } 

  fetchSafeMapInView().catch(console.error);
});

document.getElementById('toggleSide').addEventListener('click', ()=>{ 
  document.body.classList.toggle('side-collapsed'); 
  updateSidebarToggleUI(); 
  setTimeout(resizeMapSafely, 280); 
});

// 로드 시퀀스
async function loadAndPlot(){ 
  try { 
    showLoading(true); 

    if (activeTab==='FIND'){ 
      dataset = await fetchAllFindList(50); 
    } else if (activeTab==='AMBER'){ 
      dataset = await fetchAllAmber(50); 
    } else if (activeTab==='SAFEMAP'){ 
      dataset = [];
      renderTable(1);
      return;
    } 
    
    renderTable(1); 
  } catch(e){ 
    alert('데이터 로딩 실패: '+ (e && e.message? e.message : e)); 
  } finally { 
    showLoading(false); 
  } 
}

(function initAmberDate(){ 
  const el=document.getElementById('amberDate'); 
  if (!el) return; 
  const d = new Date(); 
  const v = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); 
  el.value = v; 
})();

if (document.readyState === 'complete' || (document.readyState !== 'loading' && !document.documentElement.doScroll)) { 
  initMap(); 
} else { 
  document.addEventListener('DOMContentLoaded', initMap); 
}

(async function(){ 
  showLoading(true); 
  updateSidebarToggleUI(); 
  updateFiltersVisibility(); 
  updateLegend(); 
  await loadAndPlot(); 
})();
</script>
</body>
</html>