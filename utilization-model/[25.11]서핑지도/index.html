<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì „êµ­ í•´ìˆ˜ìš•ì¥ ì„œí•‘Â·ì•ˆì „ ì§€ë„</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <!-- MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css"
  />

  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    .container {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100vh;
      margin: 0 auto;
      background-color: #fff;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    header {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 10px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 1000;
    }
    .header-content {
      display: flex;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px;
      gap: 8px;
    }
    .logo {
      font-size: 24px;
    }
    header h1 {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      white-space: nowrap;
    }
    .header-buttons {
      margin-left: auto;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .header-buttons button {
      background-color: #ffffff;
      color: #2980b9;
      border: 1px solid #ffffff;
      border-radius: 16px;
      padding: 4px 10px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      white-space: nowrap;
    }
    .header-buttons button:hover {
      background-color: #1abc9c;
      color: #ffffff;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: row;
      min-height: 0;
    }
    #map {
      flex: 1;
      min-width: 0;
    }

    /* ì˜¤ë¥¸ìª½ ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ */
    #beach-list {
      width: 260px;
      border-left: 1px solid #e0e0e0;
      background-color: #fafafa;
      display: flex;
      flex-direction: column;
      padding: 8px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    #beach-list-title {
      font-size: 13px;
      font-weight: 700;
      margin: 4px 0 8px 0;
      color: #333;
    }
    .scroll-item {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      margin-bottom: 8px;
      background-color: #ffffff;
      border-radius: 10px;
      padding: 8px 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      border: 1px solid #e0e0e0;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
    }
    .scroll-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }
    .scroll-item h3 {
      margin: 0 0 2px 0;
      font-size: 13px;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .scroll-item .code {
      font-size: 11px;
      color: #777;
      margin-bottom: 6px;
    }
    .scroll-item .tag-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #555;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-safe {
      background-color: #2ecc71;
      color: #fff;
    }
    .badge-caution {
      background-color: #f1c40f;
      color: #fff;
    }
    .badge-danger {
      background-color: #e74c3c;
      color: #fff;
    }
    .badge-unknown {
      background-color: #95a5a6;
      color: #fff;
    }
    .surf-label {
      font-weight: 600;
      color: #2980b9;
    }
    .mini-info {
      margin-top: 4px;
      font-size: 11px;
      color: #666;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    footer {
      background-color: #333;
      color: white;
      text-align: center;
      padding: 10px 0;
      font-size: 0.8em;
    }

    /* íŒì—… ìŠ¤íƒ€ì¼ */
    .custom-popup .leaflet-popup-content-wrapper {
      background: #2c3e50;
      color: #fff;
      font-size: 13px;
      line-height: 1.5;
      border-radius: 10px;
    }
    .custom-popup .leaflet-popup-tip {
      background: #2c3e50;
    }
    .beach-popup h3 {
      margin: 0 0 8px 0;
      color: #ecf0f1;
      font-size: 16px;
      border-bottom: 1px solid #34495e;
      padding-bottom: 4px;
    }
    .beach-popup p {
      margin: 4px 0;
    }
    .popup-section {
      margin-top: 6px;
      padding: 6px;
      border-radius: 6px;
      background: #34495e;
    }
    .popup-label {
      color: #bdc3c7;
      font-size: 12px;
    }
    .popup-value {
      font-weight: 600;
      font-size: 13px;
    }
    .popup-desc {
      margin-top: 4px;
      font-size: 12px;
      color: #ecf0f1;
    }

    @media (max-width: 768px) {
      main {
        flex-direction: column;
      }
      #beach-list {
        width: 100%;
        height: 200px;
        border-left: none;
        border-top: 1px solid #e0e0e0;
      }
    }

    /* ì „ì²´ í™”ë©´ ë®ëŠ” ë¡œë”© ì˜¤ë²„ë ˆì´ */
    #loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    /* ë¡œë”© ë°•ìŠ¤ */
    #loading-box {
      width: 320px;
      background: #ffffff;
      padding: 20px 25px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.25);
    }

    #loading-title {
      font-size: 18px;
      margin-bottom: 15px;
      font-weight: bold;
    }

    #loading-progressbar {
      width: 100%;
      height: 14px;
      background: #eee;
      border-radius: 7px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    #loading-progress {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #4CAF50, #2e8e41);
      transition: width 0.25s ease;
    }

    #loading-count {
      font-size: 14px;
      color: #333;
    }

    .header-buttons {
      display: flex;
      align-items: center;   
      gap: 6px;
    }
    
    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      font-size: 13px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3); 
      color: #c0392b; 
      cursor: pointer;
    }

    .tooltip-content {
        position: absolute;
        top: 120%;              /* ì•„ì´ì½˜ ë°”ë¡œ ì•„ë˜ë¡œ */
        left: 50%;              /* ì•„ì´ì½˜ ê°€ìš´ë° ê¸°ì¤€ */
        transform: translateX(-50%);  /* ê°€ìš´ë° ì •ë ¬ ë³´ì • */
        right: auto;            /* ê¸°ì¡´ right:0 ì“°ì§€ ë§ê¸° */
        width: 330px;           /* ë„ˆê°€ ë§í•œ ê²ƒì²˜ëŸ¼ ì¡°ê¸ˆ ë„“ê²Œ */
        background: #2c3e50;
        color: #ecf0f1;
        padding: 10px 12px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
        font-size: 13px;
        line-height: 1.4;
        z-index: 1500;
        display: none;
      }

      .tooltip-content ul {
        padding-left: 18px;
        margin: 4px 0;
      }

      .tooltip-content hr {
        border: 0;
        border-top: 1px solid #34495e;
        margin: 6px 0;
      }

      .header-tooltip {
        position: relative;
        margin-left: 4px;  /* ë²„íŠ¼ê³¼ ê°„ê²© ì •ë„ë§Œ */
      }


      .header-tooltip:hover .tooltip-content {
        display: block;
      }

      .header-source {
        font-size: 10px;
        color: rgba(255,255,255,0.8);
        padding-left: 10px;
        white-space: nowrap;
      }


  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-content">
      <div class="logo">ğŸŒŠ</div>
      <h1>ì „êµ­ í•´ìˆ˜ìš•ì¥ ì„œí•‘Â·ì•ˆì „ ì§€ë„</h1>

      <div class="header-buttons">
        <div class="header-tooltip">
        <span class="tooltip-icon">i</span>
        <div class="tooltip-content">
          <strong>ì„œí•‘ ì•ˆì „ë„ ì•ˆë‚´</strong>
          <ul>
            <li><b>ì•ˆì „</b> â€“ í’ì† ì•½í•¨, ìˆ˜ì˜¨/ì¡°ìœ„ ì•ˆì •ì ì¸ ìƒíƒœ</li>
            <li><b>ì£¼ì˜</b> â€“ ë°”ëŒì´ ë‹¤ì†Œ ê°•í•˜ê±°ë‚˜ ìˆ˜ì˜¨Â·ì¡°ìœ„ê°€ ë‹¤ì†Œ ë¶ˆì•ˆì •</li>
            <li><b>ìœ„í—˜</b> â€“ ê°•í•œ ë°”ëŒ ë˜ëŠ” ê·¹ë‹¨ì ì¸ ìˆ˜ì˜¨Â·ì¡°ìœ„ (ì…ìˆ˜ ë¹„ì¶”ì²œ)</li>
          </ul>
          <hr />
          <strong>ì„œí•‘ ë ˆë²¨</strong>
          <ul>
            <li><b>ì„œí•‘ ë¶ˆê°€</b> â€“ íŒŒë„ ê±°ì˜ ì—†ìŒ ë˜ëŠ” ë„ˆë¬´ ê±°ì¹¨</li>
            <li><b>ì…ë¬¸ì</b> â€“ ì‘ì€ íŒŒë„, ì´ˆê¸‰ ì—°ìŠµìš©</li>
            <li><b>ì¤‘ê¸‰</b> â€“ ì–´ëŠ ì •ë„ í˜ ìˆëŠ” íŒŒë„</li>
            <li><b>ìƒê¸‰</b> â€“ í° íŒŒë„, ê²½í—˜ì ê¶Œì¥</li>
            <li><b>ë§¤ìš° ìœ„í—˜</b> â€“ í’ì†Â·íŒŒê³  ëª¨ë‘ ê±°ì¹œ ìƒíƒœ</li>
          </ul>
        </div>
      </div>
      
        <button id="btn-korea">ì „êµ­</button>
        <button id="btn-west">ì„œí•´ì•ˆ</button>
        <button id="btn-east">ë™í•´ì•ˆ</button>
        <button id="btn-south">ë‚¨í•´ì•ˆ</button>
        <button id="btn-jeju">ì œì£¼</button>
      </div>

      <div class="header-source">ë°ì´í„° ì¶œì²˜ : í•´ì–‘ìˆ˜ì‚°ë¶€ ë°”ë‹¤ëˆ„ë¦¬ í•´ì–‘ì •ë³´ ì„œë¹„ìŠ¤</div>
    </div>
  </header>

  <main>
    <div id="map"></div>
    <div id="beach-list">
      <div id="beach-list-title">í˜„ì¬ í™”ë©´ ë‚´ í•´ìˆ˜ìš•ì¥</div>
      <!-- ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
    </div>
  </main>

  <footer></footer>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loading-overlay">
  <div id="loading-box">
    <div id="loading-title">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="loading-progressbar">
      <div id="loading-progress"></div>
    </div>
    <div id="loading-count">0 / 0</div>
  </div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<!-- MarkerCluster JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>

<script>
  const VWORLD_KEY    = "CEB52025-E065-364C-9DBA-44880E3B02B8";  
  const BEACH_GEOJSON = "beach.geojson"; 
  const KHOA_KEY      = "6fZi/tPHX0zju9slU5YlfQ==";
  const VWORLD_PROXY  = "https://map.vworld.kr/proxy.do?url=";

  // ------------------------------
  // 1. ì•ˆì „/ì„œí•‘ ë ˆë²¨ ê³„ì‚° (í’ì†Â·ìˆ˜ì˜¨Â·ì¡°ìœ„(+íŒŒê³  ìˆìœ¼ë©´) ê¸°ë°˜)
  // ------------------------------
  function calcSurfLevel(waveHeight, windSpeed) {
    if (waveHeight == null && windSpeed == null) return "unknown";

    // íŒŒê³ ê°€ ìˆìœ¼ë©´ íŒŒê³  + í’ì† ê¸°ì¤€
    if (waveHeight != null) {
      if (waveHeight < 0.3) return "none";
      if (waveHeight < 0.7 && (windSpeed == null || windSpeed < 8)) return "beginner";
      if (waveHeight < 1.5 && (windSpeed == null || windSpeed < 10)) return "intermediate";
      if (waveHeight >= 1.5 && (windSpeed == null || windSpeed < 12)) return "advanced";
      return "danger";
    }

    // íŒŒê³  ì—†ìœ¼ë©´ í’ì†ë§Œ ê¸°ì¤€ (ê°„ë‹¨ ë²„ì „)
    if (windSpeed != null) {
      if (windSpeed < 4) return "none";
      if (windSpeed < 8) return "beginner";
      if (windSpeed < 12) return "intermediate";
      return "danger";
    }

    return "unknown";
  }

  // í’ì†Â·ìˆ˜ì˜¨Â·ì¡°ìœ„(+íŒŒê³ ) ê¸°ë°˜ ì•ˆì „ë„
  function calcSafetyLevel(waveHeight, windSpeed, waterTemp, tide) {
    if (waveHeight == null && windSpeed == null && waterTemp == null && tide == null) {
      return "unknown";
    }

    let score = 0;

    // íŒŒê³  (ìˆìœ¼ë©´)
    if (waveHeight != null) {
      if (waveHeight < 0.5) score += 0;
      else if (waveHeight < 1.5) score += 1;
      else score += 2;
    }

    // í’ì†
    if (windSpeed != null) {
      if (windSpeed < 6) score += 0;
      else if (windSpeed < 10) score += 1;
      else score += 2;
    }

    // ìˆ˜ì˜¨ (ë„ˆë¬´ ì°¨ê°‘ê±°ë‚˜ / ë„ˆë¬´ ëœ¨ê±°ìš°ë©´ ë¦¬ìŠ¤í¬ +1)
    if (waterTemp != null) {
      if (waterTemp < 18 || waterTemp > 28) {
        score += 1;
      }
    }

    // ì¡°ìœ„ (ë§¤ìš° ë†’ê±°ë‚˜/ë‚®ìœ¼ë©´ +1 - ë‹¨ìˆœ ê¸°ì¤€)
    if (tide != null) {
      if (tide < 50 || tide > 250) {
        score += 1;
      }
    }

    if (score <= 1) return "safe";
    if (score === 2) return "caution";
    return "danger";
  }

  function safetyDetailText(safetyLevel, windSpeed, waterTemp, tide) {
    if (safetyLevel === "unknown") return "- ê´€ì¸¡ê°’ì´ ë¶€ì¡±í•´ ì•ˆì „ì§€ìˆ˜ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

    const parts = [];

    if (windSpeed != null) {
      if (windSpeed < 6) parts.push("- ë°”ëŒì´ ë¹„êµì  ì•½í•´ìš”.");
      else if (windSpeed < 10) parts.push("- ë°”ëŒì´ ë‹¤ì†Œ ê°•í•´ì„œ íŒŒë„ê°€ ê±°ì¹  ìˆ˜ ìˆì–´ìš”.");
      else parts.push("- ë°”ëŒì´ ê°•í•˜ê²Œ ë¶ˆì–´ í•´ìƒ ìƒíƒœê°€ ë¶ˆì•ˆì •í•´ìš”.");
    }

    if (waterTemp != null) {
      if (waterTemp < 18) parts.push("- ìˆ˜ì˜¨ì´ ë‚®ì•„ ì²´ì˜¨ ì €í•˜ì— ì£¼ì˜ê°€ í•„ìš”í•´ìš”.");
      else if (waterTemp > 28) parts.push("- ìˆ˜ì˜¨ì´ ë†’ì•„ ë”ìœ„ì™€ íƒˆìˆ˜ì— ìœ ì˜í•˜ì„¸ìš”.");
      else parts.push("- ìˆ˜ì˜¨ì€ ëŒ€ì²´ë¡œ ë¬´ë‚œí•œ í¸ì´ì—ìš”.");
    }

    if (tide != null) {
      if (tide < 50) parts.push("- ì¡°ìœ„ê°€ ë‚®ì•„ ì—¬ë°­Â·ì•”ì´ˆ ë“±ì— ì£¼ì˜í•˜ì„¸ìš”.");
      else if (tide > 250) parts.push("- ì¡°ìœ„ê°€ ë†’ì•„ í•´ë³€ ê²½ê³„ê°€ ì¢ì•„ì§ˆ ìˆ˜ ìˆì–´ìš”.");
    }

    if (!parts.length) {
      if (safetyLevel === "safe") return "- í˜„ì¬ ì¡°ê±´ì€ ë¹„êµì  ì•ˆì „í•œ í¸ì…ë‹ˆë‹¤.";
      if (safetyLevel === "caution") return "- ì¼ë¶€ ì¡°ê±´ì´ ì¢‹ì§€ ì•Šì•„ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
      return "- ì¡°ê±´ì´ ì¢‹ì§€ ì•Šì•„ ë¬¼ë†€ì´Â·ì„œí•‘ ì‹œ ê°ë³„í•œ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
    }

    return parts.join("<br>");
  }

  function colorBySafety(level) {
    switch (level) {
      case "safe":    return "#2ecc71";
      case "caution": return "#f1c40f";
      case "danger":  return "#e74c3c";
      default:        return "#7f8c8d";
    }
  }

  function labelSurfLevel(level) {
    switch (level) {
      case "none":         return "ì„œí•‘ ë¶ˆê°€";
      case "beginner":     return "ì…ë¬¸ì";
      case "intermediate": return "ì¤‘ê¸‰";
      case "advanced":     return "ìƒê¸‰";
      case "danger":       return "ë§¤ìš° ìœ„í—˜";
      default:             return "ì •ë³´ ì—†ìŒ";
    }
  }

  // ë¡œë”© ì˜¤ë²„ë ˆì´
  function showLoading(total) {
    const overlay = document.getElementById("loading-overlay");
    overlay.style.display = "flex";
    document.getElementById("loading-title").textContent = "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
    document.getElementById("loading-count").innerText = `0 / ${total}`;
    document.getElementById("loading-progress").style.width = "0%";
  }

  function hideLoading() {
    document.getElementById("loading-overlay").style.display = "none";
  }

  function updateLoading(current, total) {
    const percent = Math.round((current / total) * 100);
    document.getElementById("loading-count").innerText = `${current} / ${total}`;
    document.getElementById("loading-progress").style.width = percent + "%";
  }


  // ------------------------------
  // 2. BeachMap í´ë˜ìŠ¤
  // ------------------------------
  class BeachMap {
    constructor(mapId, listId) {
      this.map = L.map(mapId, { minZoom: 6 }).setView([36.5, 127], 7);
      L.tileLayer(
        "https://api.vworld.kr/req/wmts/1.0.0/" +
          VWORLD_KEY +
          "/Base/{z}/{y}/{x}.png",
        {
          maxZoom: 18,
          attribution: 'ë°°ê²½ì§€ë„ &copy; <a href="https://www.vworld.kr/">ë¸Œì´ì›”ë“œ</a>',
        }
      ).addTo(this.map);
      this.map.removeControl(this.map.zoomControl);

      this.listContainer = document.getElementById(listId);
      this.cluster = L.markerClusterGroup();
      this.map.addLayer(this.cluster);

      // íŒŒë„ ì•„ì´ì½˜ (ì¡°ê¸ˆ ë” "ì§„ì§œ íŒŒë„" ëŠë‚Œ)
      this.iconBeach = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/3075/3075977.png",
        iconSize: [26, 26],
        iconAnchor: [13, 26],
        popupAnchor: [0, -24],
      });

      // beachMarkers: { beach_code: { marker, props, obs } }
      this.beachMarkers = {};

      this.map.on("moveend", () => this.updateList());
    }

    async loadBeaches() {
      const res = await fetch(BEACH_GEOJSON);
      const geojson = await res.json();

      L.geoJSON(geojson, {
        pointToLayer: (feature, latlng) => {
          const props = feature.properties || {};
          const marker = L.marker(latlng, { icon: this.iconBeach });

          const obs = {
            wave_height: null,
            wind_speed: null,
            water_temp: null,
            tide: null,
            obs_time: null,
            wind_direct: null,
            safety: "unknown",
            surf: "unknown",
          };

          const beachCode = props.beach_code;
          this.beachMarkers[beachCode] = { marker, props, obs };

          marker.on("click", () => this.showPopup(beachCode));
          marker.addTo(this.cluster);

          return marker;
        },
      });

      this.updateList();
    }

    getAllMarkers() {
      const markers = [];
      this.cluster.eachLayer((layer) => {
        if (layer instanceof L.Marker) markers.push(layer);
      });
      return markers;
    }

    moveTo(lat, lng, zoom = 13) {
      this.map.setView([lat, lng], zoom);
    }

    updateList() {
      const bounds = this.map.getBounds();
      const title = document.getElementById("beach-list-title");
      this.listContainer.innerHTML = "";
      if (title) this.listContainer.appendChild(title);

      const markers = this.getAllMarkers();

      markers.forEach((marker) => {
        const latlng = marker.getLatLng();
        if (!bounds.contains(latlng)) return;

        let foundCode = null;
        for (const [code, obj] of Object.entries(this.beachMarkers)) {
          if (obj.marker === marker) {
            foundCode = code;
            break;
          }
        }
        if (!foundCode) return;

        const { props, obs } = this.beachMarkers[foundCode];

        const safety = obs.safety || "unknown";
        const surf   = obs.surf   || "unknown";

        const div = document.createElement("div");
        div.className = "scroll-item";
        div.onclick = () => {
          this.moveTo(latlng.lat, latlng.lng, 14);
          this.showPopup(foundCode);
        };

        const badgeClass =
          safety === "safe"
            ? "badge-safe"
            : safety === "caution"
            ? "badge-caution"
            : safety === "danger"
            ? "badge-danger"
            : "badge-unknown";

        const windTxt  = obs.wind_speed  != null ? obs.wind_speed  + " m/s" : "-";
        const tempTxt  = obs.water_temp  != null ? obs.water_temp  + " â„ƒ"   : "-";
        const tideTxt  = obs.tide        != null ? obs.tide        + " cm"  : "-";

        div.innerHTML = `
          <h3>${props.beach_name || "-"}</h3>
          <div class="code">${props.beach_code || ""}</div>
          <div class="tag-row">
            <span class="badge ${badgeClass}">
              ${
                safety === "safe"
                  ? "ì•ˆì „"
                  : safety === "caution"
                  ? "ì£¼ì˜"
                  : safety === "danger"
                  ? "ìœ„í—˜"
                  : "ì •ë³´ ì—†ìŒ"
              }
            </span>
            <span class="surf-label">${labelSurfLevel(surf)}</span>
          </div>
          <div class="mini-info">
            <span>í’ì†: ${windTxt}</span>
            <span>ìˆ˜ì˜¨: ${tempTxt}</span>
            <span>ì¡°ìœ„: ${tideTxt}</span>
          </div>
        `;
        this.listContainer.appendChild(div);
      });
    }

    showPopup(beachCode) {
      const obj = this.beachMarkers[beachCode];
      if (!obj) return;
      const { marker, props, obs } = obj;

      const waveTxt  = obs.wave_height != null ? obs.wave_height + " m" : "-";
      const windTxt  = obs.wind_speed  != null ? obs.wind_speed  + " m/s" : "-";
      const tempTxt  = obs.water_temp  != null ? obs.water_temp  + " â„ƒ" : "-";
      const tideTxt  = obs.tide        != null ? obs.tide        + " cm" : "-";
      const timeTxt  = obs.obs_time    || "-";
      const dirTxt   = obs.wind_direct || "-";

      const safety   = obs.safety || "unknown";
      const surf     = obs.surf   || "unknown";

      const safetyLabel =
        safety === "safe"
          ? "ì•ˆì „"
          : safety === "caution"
          ? "ì£¼ì˜"
          : safety === "danger"
          ? "ìœ„í—˜"
          : "ì •ë³´ ì—†ìŒ";

      const descText = safetyDetailText(
        safety,
        obs.wind_speed,
        obs.water_temp,
        obs.tide
      );

      const html = `
        <div class="beach-popup">
          <h3>${props.beach_name || ""}</h3>
          <p class="popup-label">ì½”ë“œ: <span class="popup-value">${props.beach_code || ""}</span></p>
          <p class="popup-label">ê´€ì¸¡ì‹œê°„: <span class="popup-value">${timeTxt}</span></p>
          <div class="popup-section">
            <p class="popup-label">í’í–¥: <span class="popup-value">${dirTxt}</span></p>
            <p class="popup-label">íŒŒê³ : <span class="popup-value">${waveTxt}</span></p>
            <p class="popup-label">í’ì†: <span class="popup-value">${windTxt}</span></p>
            <p class="popup-label">ìˆ˜ì˜¨: <span class="popup-value">${tempTxt}</span></p>
            <p class="popup-label">ì¡°ìœ„: <span class="popup-value">${tideTxt}</span></p>
          </div>
          <div class="popup-section" style="margin-top:6px;">
            <p class="popup-label">ì•ˆì „ë„: <span class="popup-value">${safetyLabel}</span></p>
            <p class="popup-label">ì„œí•‘ ë ˆë²¨: <span class="popup-value">${labelSurfLevel(surf)}</span></p>
            <div class="popup-desc">${descText}</div>
          </div>
        </div>
      `;

      marker.bindPopup(html, {
        className: "custom-popup",
        maxWidth: 280,
      }).openPopup();
    }

    // ------------------------------
    // KHOA ê´€ì¸¡ í˜¸ì¶œ (í”„ë¡ì‹œ + ìƒˆ ì‘ë‹µ êµ¬ì¡°)
    // ------------------------------
    async refreshAllObservations() {
      const codes = Object.keys(this.beachMarkers); // beach_code ë°°ì—´
      const total = codes.length;
      let current = 0;

      showLoading(total);

      for (const code of codes) {
        await this.fetchObservation(code).catch(() => {});
        current++;
        updateLoading(current, total);
      }

      hideLoading();
      this.updateList(); // ê´€ì¸¡ê°’ ë‹¤ ê°±ì‹  í›„ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ê·¸ë¦¼ (ì„ íƒ)
    }

    async fetchObservation(beachCode) {
      const obj = this.beachMarkers[beachCode];
      if (!obj) return;

      const props = obj.props;
      const base  = "http://www.khoa.go.kr/api/oceangrid/beach/search.do";

      // KHOA ì‹¤ì œ URL
      const khoaUrl =
        base +
        "?ServiceKey=" + encodeURIComponent(KHOA_KEY) +
        "&BeachCode=" + encodeURIComponent(props.beach_code) +
        "&ResultType=json";

      // í”„ë¡ì‹œë¡œ ê°ì‹¸ê¸° (ì „ì²´ URL ì¸ì½”ë”©)
      const finalUrl = VWORLD_PROXY + encodeURIComponent(khoaUrl);

      try {
        const res = await fetch(finalUrl);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();

        const meta = json?.result?.meta || {};
        const dataArr = json?.result?.data || [];
        if (!dataArr.length) return;

        const latest = dataArr[0]; // ì´ APIëŠ” 1ê±´ë§Œ ë°˜í™˜

        const wave = latest.wave_height != null ? Number(latest.wave_height) : null;
        const wind = latest.wind_speed  != null ? Number(latest.wind_speed)  : null;
        const temp = latest.water_temp  != null ? Number(latest.water_temp)  : null;
        const tide = latest.tide        != null ? Number(latest.tide)        : null;
        const time = latest.obs_time    || null;
        const dir  = latest.wind_direct || null;

        const safety = calcSafetyLevel(wave, wind, temp, tide);
        const surf   = calcSurfLevel(wave, wind);

        obj.obs = {
          wave_height: wave,
          wind_speed:  wind,
          water_temp:  temp,
          tide,
          obs_time:    time,
          wind_direct: dir,
          safety,
          surf,
          meta
        };

        const color = colorBySafety(safety);
        obj.marker.setIcon(
          L.divIcon({
            html:
              `<div style="width:18px;height:18px;border-radius:50%;
              background:${color};border:2px solid #fff;
              box-shadow:0 0 4px rgba(0,0,0,.6)"></div>`,
            className: "",
            iconSize: [18, 18],
            iconAnchor: [9, 9],
          })
        );

      } catch (e) {
        console.error("ê´€ì¸¡ê°’ ì¡°íšŒ ì‹¤íŒ¨:", beachCode, e);
      }
    }
  }

  // ------------------------------
  // ì´ˆê¸°í™”
  // ------------------------------
  document.addEventListener("DOMContentLoaded", async () => {
    const beachMap = new BeachMap("map", "beach-list");
    await beachMap.loadBeaches();
    await beachMap.refreshAllObservations();

    document.getElementById("btn-korea").onclick = () =>
      beachMap.moveTo(36.5, 127, 7);
    document.getElementById("btn-west").onclick = () =>
      beachMap.moveTo(36.5, 126.3, 8); 
    document.getElementById("btn-east").onclick = () =>
      beachMap.moveTo(37.6, 129.3, 8);
    document.getElementById("btn-south").onclick = () =>
      beachMap.moveTo(34.5, 128, 8);
    document.getElementById("btn-jeju").onclick = () =>
      beachMap.moveTo(33.4, 126.5, 9);
  });
</script>
</body>
</html>
